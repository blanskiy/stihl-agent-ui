"""
STIHL Analytics Agent - FastAPI Application
Simplified main.py using direct Azure OpenAI function calling.
"""

import os
import logging
from contextlib import asynccontextmanager

import fastapi
from fastapi import Request
from fastapi.staticfiles import StaticFiles
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("stihl-agent")


@asynccontextmanager
async def lifespan(app: fastapi.FastAPI):
    """Application lifespan - initialize and cleanup."""
    logger.info("Starting STIHL Analytics Agent...")
    
    # Import here to ensure env vars are loaded
    from agent.stihl_agent import STIHLAnalyticsAgent
    
    try:
        # Create agent instance
        agent = STIHLAnalyticsAgent(use_skill_routing=True)
        app.state.agent = agent
        logger.info("STIHL Analytics Agent initialized successfully")
        logger.info(f"Skills available: {[s['name'] for s in agent.list_skills()]}")
        yield
    except Exception as e:
        logger.error(f"Failed to initialize agent: {e}")
        raise
    finally:
        logger.info("Shutting down STIHL Analytics Agent")


def create_app() -> fastapi.FastAPI:
    """Create and configure the FastAPI application."""
    
    app = fastapi.FastAPI(
        title="STIHL Analytics Agent",
        description="AI-powered analytics for STIHL equipment data",
        version="1.0.0",
        lifespan=lifespan
    )
    
    # CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # Mount static files if directory exists
    static_dir = os.path.join(os.path.dirname(__file__), "static")
    if os.path.exists(static_dir):
        app.mount("/static", StaticFiles(directory=static_dir), name="static")
    
    # Import and include routes
    from routes import router
    app.include_router(router)
    
    # Global exception handler
    @app.exception_handler(Exception)
    async def global_exception_handler(request: Request, exc: Exception):
        logger.error(f"Unhandled exception: {exc}", exc_info=True)
        return JSONResponse(
            status_code=500,
            content={"detail": "Internal server error"}
        )
    
    return app


# Create the app instance
app = create_app()


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000, reload=True)